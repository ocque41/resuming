# AWS Lambda Setup Guide for Python FastAPI Application

## Introduction
This guide provides detailed instructions for deploying a Python FastAPI application to AWS Lambda with API Gateway integration. The document covers the adaptation of the existing codebase, configuration of AWS services, and testing procedures.

## Prerequisites
- AWS account with administrative access
- Python 3.9 or higher installed locally
- AWS CLI installed and configured
- Basic familiarity with FastAPI and AWS concepts

## Part 1: Preparing Your FastAPI Application for AWS Lambda

### Step 1: Installing Required Dependencies
Add the following packages to your `requirements.txt` file:
```
mangum>=0.15.0
aws-lambda-powertools>=2.15.0
```

Mangum is an adapter that allows ASGI applications (like FastAPI) to run in AWS Lambda.

### Step 2: Creating Lambda Handler
Create a new file called `lambda_handler.py` in your project root:

```python
from mangum import Mangum
from main import app
import os
import logging

# Configure logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# Create Mangum handler
handler = Mangum(app)

def lambda_handler(event, context):
    """
    AWS Lambda entry point.
    This function is called by AWS Lambda service when a request is made.
    """
    logger.info("Lambda function invoked")
    return handler(event, context)
```

### Step 3: Modifying Your FastAPI Application
Update your `main.py` file to be Lambda-compatible:

```python
import os
import logging
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from dotenv import load_dotenv

# Load environment variables from .env file (in development)
# In Lambda, these will be configured as environment variables
if os.path.exists(".env"):
    load_dotenv()

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
)
logger = logging.getLogger(__name__)

# Check OpenAI API key
if not os.getenv("OPENAI_API_KEY"):
    logger.error("OPENAI_API_KEY environment variable not set")
    raise ValueError("OPENAI_API_KEY must be set as an environment variable")

# Import routers after environment variables are loaded
from routers.agent_router import router as agent_router

# Create FastAPI app
app = FastAPI(
    title="Document AI API",
    description="API for document analysis, editing, and creation using OpenAI Agents",
    version="0.1.0",
    root_path=os.getenv("API_GATEWAY_STAGE", "")  # Required for API Gateway stage mapping
)

# Configure CORS
allowed_origins = os.getenv("ALLOWED_ORIGINS", "*").split(",")
app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Include routers
app.include_router(agent_router)

@app.get("/")
async def root():
    """Root endpoint to verify the API is running."""
    return {
        "status": "ok",
        "message": "Document AI API is running",
        "version": "0.1.0",
        "environment": os.getenv("ENVIRONMENT", "development")
    }

@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "ok"}

# This is only used when running locally with uvicorn
# It will not be used in Lambda
if __name__ == "__main__":
    import uvicorn
    port = int(os.getenv("PORT", 8000))
    host = os.getenv("HOST", "0.0.0.0")
    
    logger.info(f"Starting Document AI API on {host}:{port}")
    
    uvicorn.run(
        "main:app",
        host=host,
        port=port,
        reload=True,  # Enable auto-reload during development
    )
```

### Step 4: Creating the Deployment Package
1. Create a deployment package by installing dependencies in a local directory:
   ```bash
   mkdir -p deployment/package
   pip install -r requirements.txt --target deployment/package
   ```

2. Copy your application code to the package directory:
   ```bash
   cp -r *.py routers/ config/ deployment/package/
   ```

3. Create a zip file of the package:
   ```bash
   cd deployment/package
   zip -r ../deployment-package.zip .
   cd ../..
   ```

## Part 2: Setting Up AWS Lambda and API Gateway

### Step 1: Creating a Lambda Function
1. Sign in to the AWS Management Console
2. Navigate to the Lambda service
3. Click "Create function"
4. Select "Author from scratch"
5. Enter function details:
   - Function name: `ai-document-agent-api`
   - Runtime: Python 3.9
   - Architecture: x86_64
6. Expand "Permissions" section:
   - Select "Create a new role with basic Lambda permissions"
7. Click "Create function"

### Step 2: Uploading the Deployment Package
1. In the Function overview section, scroll down to the "Code" tab
2. Click "Upload from" dropdown and select ".zip file"
3. Click "Upload" and select your `deployment-package.zip` file
4. Click "Save"

### Step 3: Configuring Lambda Settings
1. In the "Configuration" tab, click "General configuration" and then "Edit"
   - Memory: Set to 512 MB (increase if needed)
   - Timeout: Set to 30 seconds
   - Click "Save"

2. In the "Configuration" tab, click "Environment variables" and then "Edit"
   - Add the following variables:
     * `OPENAI_API_KEY`: Your OpenAI API key
     * `OPENAI_ORGANIZATION_ID`: Your OpenAI organization ID
     * `AWS_S3_BUCKET`: Your document storage bucket name
     * `ENVIRONMENT`: `production`
     * `API_GATEWAY_STAGE`: `/prod` (this will match the API Gateway stage name)
     * `ALLOWED_ORIGINS`: Comma-separated list of allowed origins for CORS
   - Click "Save"

3. In the "Configuration" tab, click "Permissions" to review the execution role
   - Note the role name (e.g., `ai-document-agent-api-role-xxxx`)

### Step 4: Adding Permissions to Lambda Role
1. Navigate to the IAM service
2. Click "Roles" in the left navigation
3. Find and click on the role created for your Lambda function
4. Click "Add permissions" and select "Attach policies"
5. Search for and attach the following policies:
   - `AmazonS3ReadOnlyAccess` (or a more specific policy for your bucket)
   - `AmazonDynamoDBFullAccess` (or a more specific policy for your tables)
   - `CloudWatchLogsFullAccess`
6. Click "Attach policies"

### Step 5: Creating API Gateway
1. Navigate to the API Gateway service
2. Click "Create API"
3. Select "REST API" and click "Build"
4. Choose "New API" and enter:
   - API name: `AI-Document-Agent-API`
   - Description: `API for the AI Document Agent service`
   - Endpoint Type: Regional
5. Click "Create API"

### Step 6: Creating Resources and Methods
1. Click "Actions" dropdown and select "Create Resource"
   - Resource Name: `agent`
   - Resource Path: `/agent`
   - Check "Enable API Gateway CORS"
   - Click "Create Resource"

2. With the `/agent` resource selected:
   - Click "Actions" dropdown and select "Create Resource"
   - Resource Name: `message`
   - Resource Path: `/message`
   - Check "Enable API Gateway CORS"
   - Click "Create Resource"

3. With the `/agent/message` resource selected:
   - Click "Actions" dropdown and select "Create Method"
   - Select "POST" from the dropdown and click the checkmark
   - Integration type: Lambda Function
   - Lambda Function: Select your region and enter `ai-document-agent-api`
   - Check "Use Lambda Proxy integration"
   - Click "Save"
   - Click "OK" when prompted to allow API Gateway to invoke your Lambda function

4. Create similar resource and method for `/agent/message/stream` with a POST method

5. Create health check endpoint:
   - Create resource `/agent/health` with GET method
   - Integration type: Lambda Function
   - Lambda Function: Select your region and enter `ai-document-agent-api`
   - Check "Use Lambda Proxy integration"
   - Click "Save"

### Step 7: Deploying the API
1. Click "Actions" dropdown and select "Deploy API"
2. In the "Deploy API" dialog:
   - Deployment stage: Select "New Stage"
   - Stage name: `prod`
   - Stage description: `Production stage`
   - Deployment description: `Initial deployment`
3. Click "Deploy"

### Step 8: Configuring Usage Plan (Optional)
1. In the left navigation, click "Usage Plans"
2. Click "Create"
3. Enter plan details:
   - Name: `Standard-Plan`
   - Description: `Standard usage plan for AI Document Agent API`
   - Enable throttling: Rate 10 requests/second, Burst 20 requests
   - Enable quota: 1000 requests per day
4. Click "Next"
5. Associate API stages: Select your API and prod stage
6. Click "Next"
7. Create an API key if needed
8. Click "Done"

## Part 3: Testing the Deployed API

### Step 1: Getting the API Endpoint
1. In API Gateway, click "Stages" in the left navigation
2. Select the "prod" stage
3. Copy the "Invoke URL" shown at the top of the page
   - This is your base API URL, e.g., `https://abc123def.execute-api.us-east-1.amazonaws.com/prod`

### Step 2: Testing the Health Endpoint
1. Using curl or a tool like Postman, make a GET request to `{base-url}/agent/health`
   ```bash
   curl https://abc123def.execute-api.us-east-1.amazonaws.com/prod/agent/health
   ```
2. Expected response: `{"status":"ok"}`

### Step 3: Testing the Message Endpoint
1. Using curl or Postman, make a POST request to `{base-url}/agent/message`
   ```bash
   curl -X POST \
     https://abc123def.execute-api.us-east-1.amazonaws.com/prod/agent/message \
     -H 'Content-Type: application/json' \
     -d '{
       "messages": [{"role": "user", "content": "Hello", "id": "test-message"}],
       "mode": "analyze"
     }'
   ```
2. Verify you receive a proper response from the agent

## Part 4: Updating the Frontend

### Step 1: Updating Environment Variables
Update your frontend `.env.local` file to use the new API endpoint:
```
NEXT_PUBLIC_API_URL=https://abc123def.execute-api.us-east-1.amazonaws.com/prod
```

### Step 2: Updating API Client Code
Ensure your frontend code uses the configured API URL:

```typescript
// app/lib/agent-api.ts
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

export const sendMessageToAgent = async (messages, mode = 'analyze') => {
  const response = await fetch(`${API_URL}/agent/message`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      messages,
      mode,
    }),
  });
  
  if (!response.ok) {
    throw new Error(`API error: ${response.status}`);
  }
  
  return await response.json();
};
```

## Part 5: Monitoring and Troubleshooting

### Step 1: Setting Up CloudWatch Logging
1. Navigate to CloudWatch service
2. In the left navigation, click "Log groups"
3. Find the log group for your Lambda function: `/aws/lambda/ai-document-agent-api`
4. Click on the log group to view function logs

### Step 2: Creating CloudWatch Alarm
1. In CloudWatch, click "Alarms" in the left navigation
2. Click "Create alarm"
3. Click "Select metric"
4. Navigate to "Lambda" > "By Function Name"
5. Find and select your function's "Errors" metric
6. Click "Select metric"
7. Configure alarm:
   - Threshold type: Static
   - Whenever Errors is: Greater than or equal to 1
   - Period: 5 minutes
8. Click "Next"
9. Configure notification:
   - Select an existing SNS topic or create a new one
   - Add your email to receive notifications
10. Click "Next", add a name and description
11. Click "Create alarm"

## Common Issues and Solutions

### CORS Errors
If you see CORS errors in your frontend:
1. In API Gateway, select your API
2. For each resource, click "Actions" and select "Enable CORS"
3. Click "Enable CORS and replace existing CORS headers"
4. Re-deploy your API

### Lambda Timeout Errors
If your Lambda function times out:
1. Increase the timeout in Lambda configuration
2. Optimize your code for better performance
3. Consider increasing memory allocation

### Missing Environment Variables
If your function fails due to missing environment variables:
1. Check Lambda configuration > Environment variables
2. Verify all required variables are set
3. Check for typos in variable names

### Permission Issues
If you see access denied errors:
1. Check your Lambda execution role in IAM
2. Verify it has all necessary permissions
3. Check if you need to add policies for S3, DynamoDB, etc.

## Next Steps
1. Set up CloudFront for caching (optional)
2. Implement automated deployments using AWS CodePipeline
3. Set up monitoring dashboards in CloudWatch
4. Configure backup and disaster recovery procedures

## Reference Screenshots
The [AWS Lambda Console Screenshots](https://documentation-link-placeholder.com) document contains reference screenshots for all steps in this guide. Use it alongside these instructions for visual guidance. 